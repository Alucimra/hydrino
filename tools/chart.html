<!DOCTYPE html>
<html>
  <head>
    <title>Hello</title>
    <script src="./js/jquery-3.2.1.min.js"></script>
    <script src="./js/popper.min.js"></script>
    <script src="./js/popper-utils.min.js"></script>
    <script src="./bootstrap-4.0.0b/js/bootstrap.min.js"></script>
    <script src="./js/d3.min.js"></script>
    <script src="./js/nv.d3.min.js"></script>
    <link rel="stylesheet" href="./bootstrap-4.0.0b/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="./css/nv.d3.min.css"/>
  </head>
  <body>
    <div class="container-fluid" id="chart">
      <svg style="height: 500px; width: 100%;"></svg>
    </div>
    <div class="container">
      <form>
        <div class="form-group">
          <textarea class="form-control" id="logs" rows=10></textarea>
          <input type="button" id="charge_remaining" class="btn" value="Charge Remaining (Scatterplot)" />
          <input type="button" id="on_off_times" class="btn" value="On/Off Times" />
        </div>
        <div class="form-group">
          <label>Time</label>
          <input type="text" class="form-control" id="x" />
        </div>
        <div class="form-group">
          <label>Volts</label>
          <input type="text" class="form-control" id="y" />
        </div>
      </form>
    </div>
    <script>
      var $chart, chart;
      var parsedData = {};
      function parseData(){
        if(parsedData.x && parsedData.y){ return; }

        var x = [];
        var y = [];
        var time = 0;
        $.each($('#logs').val().split("\n"), function(i, line){
          var data = line.split("\t");
          if(data.length != 3){ return; }

          if(Number(data[0]) % 2 == 1){
            // odd, so read voltage
            y.push(Number(data[2]));
          } else {
            // even, so read time
            x.push(time);
            time += Number(data[2]);
          }
        });
        parsedData.x = x;
        parsedData.y = y;

        $('#x').val('time <- c(' + x.join(',') + ')');
        $('#y').val('volts <- c(' + y.join(',') + ')');
      }

      $(function(){
        $chart = $('#chart');

        $('#logs').change(function(){
          parsedData = {};
        });

        $('#charge_remaining').click(function(){
          parseData();
          // http://nvd3.org/examples/scatter.html
          var chart = nv.models.scatterChart()
                        .showDistX(false)
                        .showDistY(false)
                        .color(d3.scale.category10().range());

          chart.xAxis.tickFormat(d3.format('.3s'));
          chart.yAxis.tickFormat(d3.format('.2f'));

          var scatterData = [],
              shapes = ['circle', 'cross', 'triangle-up', 'triangle-down', 'diamond', 'square'];
          scatterData.push({key: 'Voltage', values: []});
          $.each(parsedData.x, function(i, val){
            scatterData[0].values.push({x: val, y: parsedData.y[i], size: 1, shape: 'circle'});
          });

          d3.select('#chart svg').datum(scatterData).call(chart);
          nv.utils.windowResize(chart.update);
          window.chart = chart;
        });

        $('#on_off_times').click(function(){

        });
      });
    </script>
  </body>
</html>
