<!DOCTYPE html>
<html>
  <head>
    <title>Hello</title>
    <script src="./js/jquery-3.2.1.min.js"></script>
    <script src="./js/popper.min.js"></script>
    <script src="./js/popper-utils.min.js"></script>
    <script src="./bootstrap-4.0.0b/js/bootstrap.min.js"></script>
    <script src="./js/d3.min.js"></script>
    <script src="./js/nv.d3-old.js"></script>
    <link rel="stylesheet" href="./bootstrap-4.0.0b/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="./css/nv.d3.min.css"/>
  </head>
  <body>
    <div class="container-fluid" id="chart">
      <svg style="height: 500px; width: 100%;"></svg>
    </div>
    <div class="container">
      <form>
        <div class="form-group">
          <label>Charts</label>
          <input type="button" id="charge_remaining" class="btn" value="Charge Remaining (Scatterplot)" />
          <input type="button" id="charge_remaining_wrap" class="btn" value="Charge Remaining (Scatterplot - 24hr)" />
          <input type="button" id="on_off_times" class="btn" value="On/Off Times" />
        </div>
        <div class="form-group">
          <label>Custom Logs</label>
          <textarea class="form-control" id="logs" rows=10></textarea>
        </div>
        <div class="form-group">
          <label>Time</label>
          <input type="text" class="form-control" id="x" />
        </div>
        <div class="form-group">
          <label>Volts</label>
          <input type="text" class="form-control" id="y" />
        </div>
      </form>
    </div>
    <script src="./rawLog.js"></script>
    <script>
      var $chart, chart;
      var parsedData = {};

      function parseConfig(logs, matcher){
        var config;
        var match;
        try {
          if(match = logs.match(matcher)){
            config = JSON.parse(match[1]);
          } else {
            config = null;
          }
        } catch(e){
          console.log(e);
        }
        return config;
      }

      function parseData(){
        if(parsedData.parsedAt){ return; }

        parsedData.total_time = [];
        parsedData.power = [];
        parsedData.volts = [];
        parsedData.cycle_time = [];
        parsedData.cycles = [];
        var time = 0;
        var logs = ($('#logs').val().length == 0 ? window.rawLog : $('#logs').val());
        // printing these fields cost >4kb of program memory space!
        // have to figure out how to make use of it...
        parsedData.voltage_levels = parseConfig(logs, /:: Voltage Levels :> ({.+})/);
        parsedData.motor_timings = parseConfig(logs, /:: Motor Timing :> ({.+})/);
        parsedData.motor_power_levels = parseConfig(logs, /:: Motor Power Levels :> ({.+})/);
        parsedData.config = parseConfig(logs, /:: Config :> ({.+})/);
        parsedData.drive_config = parseConfig(logs, /:: Drive Config :> ({.+})/);

        $.each(logs.split("\n"), function(i, line){
          var data = line.split("\t");
          if(data.length != 3){ return; }

          if(Number(data[0]) % 2 == 1){
            // odd, read voltage
            parsedData.power.push(Number(data[1]));
            parsedData.volts.push(Number(data[2]));
          } else {
            // even, read time
            parsedData.cycle_time.push(Number(data[2]));
            parsedData.total_time.push(time);
            parsedData.cycles.push(Number(data[1]));
            time += Number(data[2]);
          }
        });
        parsedData.parsedAt = new Date();

        $('#x').val('time <- c(' + parsedData.total_time.join(',') + ')');
        $('#y').val('volts <- c(' + parsedData.volts.join(',') + ')');
      }

      function clearChart(){
        $chart.find('svg').children().remove();
      }

      function scatterData(wrap){
        wrap || (wrap = 0);

        var scatterData = [],
            shapes = ['circle', 'square', 'triangle-up', 'triangle-down', 'diamond', 'cross'];
        scatterData.push({key: 'On Cycle', values: []});
        scatterData.push({key: 'Off Cycle', values: []});
        $.each(parsedData.total_time, function(i, val){
          if(wrap > 0){ val = val % wrap; }
          if(parsedData.cycle_time[i] % 2 == 0 || parsedData.cycle_time[i] == 1){
            // even cycle_time or 1 means the cycle is on
            scatterData[0].values.push({x: val, y: parsedData.volts[i], size: parsedData.cycle_time[i], shape: 'circle'});
          } else {
            // odd cycle, so it's off
            scatterData[1].values.push({x: val, y: parsedData.volts[i], size: parsedData.cycle_time[i], shape: 'square'});
          }
        });

        return scatterData;
      }

      function charge_remaining_scatter(wrap){
        parseData();
        clearChart();
        // http://nvd3.org/examples/scatter.html
        var chart = nv.models.scatterChart()
                      .showDistX(false)
                      .showDistY(false)
                      .color(d3.scale.category10().range());

        chart.xAxis.tickFormat(d3.format('.3s'));
        chart.yAxis.tickFormat(d3.format('.2f'));

        d3.select('#chart svg').datum(scatterData(wrap)).call(chart);
        nv.utils.windowResize(chart.update);
        window.chart = chart;
      }

      function cycleData(wrap){
        wrap || (wrap = 0);
        var data = [{key: 'Cycle 0', values: []},
          {key: 'Cycle 1', values: []},
          {key: 'Cycle 2', values: []},
          {key: 'Cycle 3', values: []}];

        $.each(parsedData.cycles, function(i, val){
          data[val].values.push({x: Math.floor(i/4), y: parsedData.cycle_time[i]});
        });

        return data;
      }

      $(function(){
        $chart = $('#chart');

        $('#logs').change(function(){
          parsedData = {};
        });

        $('#charge_remaining').click(function(){
          charge_remaining_scatter(0);
        });

        $('#charge_remaining_wrap').click(function(){
          charge_remaining_scatter(1440);
        });

        $('#on_off_times').click(function(){
          parseData();
          clearChart();
          var chart = nv.models.multiBarChart()
            .margin({top: 50, bottom: 30, left: 40, right: 10});;


          chart.xAxis.tickFormat(d3.format(',f'));
          chart.yAxis.tickFormat(d3.format(',.1f'));

          d3.select('#chart svg')
              .datum(cycleData()).transition().duration(500)
              .call(chart);

          nv.utils.windowResize(chart.update);

          window.chart = chart;
        });
      });
    </script>
  </body>
</html>
